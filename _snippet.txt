{/* Overlay */}
        <div className="pointer-events-none absolute inset-0 flex flex-col">
          <div className="pointer-events-auto flex justify-start gap-2 p-3">
            <button
              type="button"
              onClick={() => setProjectionMode((prev) => (prev === "mercator" ? "globe" : "mercator"))}
              className="rounded-md border border-slate-200 bg-white/90 px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-white"
            >
              {projectionMode === "mercator" ? "üåç" : "üó∫Ô∏è"}
            </button>
            <button
              type="button"
              onClick={toggleFullscreen}
              className="rounded-md border border-slate-200 bg-white/90 px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-white"
              aria-label="Toggle fullscreen"
            >
              {isFullscreen ? "üû¨" : "‚õ∂"}
            </button>
            <button
              type="button"
              onClick={() => setShowMenu((prev) => !prev)}
              className="rounded-md border border-slate-200 bg-white/90 px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-white"
            >
              ‚ò∞
            </button>
          </div>

          <div
            className={`pointer-events-auto absolute left-3 top-14 z-20 max-h-[88vh] w-[320px] transform overflow-hidden rounded-2xl border border-white/30 bg-white/55 shadow-2xl ring-1 ring-white/20 backdrop-blur-xl transition-transform duration-300 ${
              showMenu ? "translate-x-0" : "-translate-x-[110%]"
            }`}
          >
            <div className="relative flex h-full flex-col">
              <div className="glass-noise pointer-events-none absolute inset-0 z-0" aria-hidden="true" />
              <div className="relative z-10 border-b border-white/30 bg-[#991B1B]/90 text-white backdrop-blur">
                <div className="flex items-center justify-between px-4 py-3">
                  <div>
                    <p className="text-xs uppercase tracking-wide text-white/80">Thanh sidebar</p>
                    <p className="text-base font-semibold">Danh sach hanh trinh</p>
                  </div>
                  <div className="rounded-full bg-white/20 px-3 py-1 text-xs font-semibold text-white backdrop-blur">
                    {sortedPlaces.length} diem
                  </div>
                </div>
                <div className="flex items-center gap-2 px-3 pb-3">
                  {sidebarSections.map((section) => {
                    const isActive = activeTab === section.key;
                    return (
                      <button
                        key={section.key}
                        type="button"
                        onClick={() => setActiveTab(section.key)}
                        className={`flex flex-1 items-center justify-center gap-2 rounded-lg border px-2 py-2 text-xs font-semibold text-white backdrop-blur transition ${
                          isActive
                            ? "border-white/50 bg-white/35"
                            : "border-white/30 bg-white/20 hover:bg-white/30"
                        }`}
                      >
                        <img
                          src={getIconSrc(section.icon) || `/media/${section.icon}`}
                          alt={section.label}
                          className="h-4 w-4 object-contain"
                        />
                        <span className="hidden sm:inline">{section.label}</span>
                      </button>
                    );
                  })}
                </div>
              </div>
              <div
                className="relative z-10 flex-1 overflow-y-auto bg-white/50 backdrop-blur-xl"
                style={{ maxHeight: "calc(88vh - 160px)" }}
              >
                {sortedPlaces.length === 0 ? (
                  <p className="p-4 text-sm text-slate-600">Chua co du lieu. Them JSON vao src/data/places.json.</p>
                ) : activeTab === "places" ? (
                  <div className="space-y-4 px-2 py-3">
                    <div ref={placeSectionRef}>
                      <p className="px-2 text-xs font-semibold uppercase tracking-wide text-[#991B1B]">Dia diem</p>
                      <div className="mt-2 divide-y divide-white/30 rounded-xl border border-white/30 bg-white/50 shadow-lg ring-1 ring-white/20 backdrop-blur-xl">
                        {sortedPlaces.map((place, index) => {
                          const key = place.id || place.slug || `place-${index}`;
                          const listIndex = sortedPlaces.indexOf(place);
                          const stepTarget = listIndex >= 0 ? listIndex : index;
                          const displayIndex = listIndex >= 0 ? listIndex + 1 : index + 1;
                          const active = activePlaceId === key;
                          return (
                            <div
                              key={`places-${key}`}
                              onClick={() => {
                                setStep(stepTarget);
                                setDetailPlace(place);
                              }}
                              className={`block w-full cursor-pointer text-left transition hover:bg-[#EAB308]/15 ${
                                active ? "bg-[#EAB308]/15" : "bg-white"
                              }`}
                            >
                              <div className="flex items-start gap-3 px-4 py-3">
                                <div
                                  className={`mt-1 h-9 w-9 shrink-0 rounded-full border text-center text-sm font-semibold leading-9 ${
                                    active
                                      ? "border-[#991B1B] bg-[#EAB308]/25 text-[#991B1B]"
                                      : "border-slate-200 bg-slate-50 text-slate-700"
                                  }`}
                                >
                                  {displayIndex}
                                </div>
                                <div className="space-y-1">
                                  <p className="text-sm font-semibold text-slate-900">{place.title}</p>
                                  <p className="text-xs text-slate-600">
                                    {[place.city, place.country].filter(Boolean).join(", ") || "Dia diem"}
                                  </p>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="space-y-4 px-2 py-3">
                    <div ref={journeySectionRef}>
                      <p className="px-2 text-xs font-semibold uppercase tracking-wide text-[#991B1B]">Hanh trinh</p>
                      <div className="mt-2 divide-y divide-white/30 rounded-xl border border-white/30 bg-white/50 shadow-lg ring-1 ring-white/20 backdrop-blur-xl">
                        {sortedPlaces.map((place, index) => {
                          const key = place.id || place.slug || `place-${index}`;
                          const listIndex = sortedPlaces.indexOf(place);
                          const stepTarget = listIndex >= 0 ? listIndex : index;
                          const displayIndex = listIndex >= 0 ? listIndex + 1 : index + 1;
                          const active = activePlaceId === key;
                          return (
                            <div
                              key={`journey-${key}`}
                              onClick={() => {
                                setStep(stepTarget);
                                setDetailPlace(place);
                              }}
                              className={`block w-full cursor-pointer text-left transition hover:bg-[#EAB308]/15 ${
                                active ? "bg-[#EAB308]/15" : "bg-white"
                              }`}
                            >
                              <div className="flex items-start gap-3 px-4 py-3">
                                <div
                                  className={`mt-1 h-9 w-9 shrink-0 rounded-full border text-center text-sm font-semibold leading-9 ${
                                    active
                                      ? "border-[#991B1B] bg-[#EAB308]/25 text-[#991B1B]"
                                      : "border-slate-200 bg-slate-50 text-slate-700"
                                  }`}
                                >
                                  {displayIndex}
                                </div>
                                <div className="space-y-1">
                                  <p className="text-sm font-semibold text-slate-900">{place.title}</p>
                                  <p className="text-xs text-slate-600">
                                    {[place.city, place.country].filter(Boolean).join(", ") || "Dia diem"}
                                  </p>
                                  {place.periodLabel || place.dateStart || place.dateEnd ? (
                                    <p className="text-xs font-medium text-[#991B1B]">
                                      {place.periodLabel ||
                                        (place.dateStart && place.dateEnd
                                          ? `${place.dateStart} -> ${place.dateEnd}`
                                          : place.dateStart || place.dateEnd)}
                                    </p>
                                  ) : null}
                                  {place.levelTexts?.primary ? (
                                    <p className="text-xs text-slate-700">{place.levelTexts.primary}</p>
                                  ) : null}
                                  {place.slug ? (
                                    <Link
                                      href={`/places/${place.slug}`}
                                      className="text-xs font-semibold text-[#991B1B] hover:text-[#7F1D1D]"
                                      onClick={(event) => event.stopPropagation()}
                                    >
                                      Chi tiet
                                    </Link>
                                  ) : null}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
          {activeTab === "journey" ? (
            <div className="pointer-events-auto absolute inset-x-0 bottom-4 flex justify-center px-4">
              <div className="flex w-full max-w-5xl flex-col gap-3 rounded-2xl border border-white/40 bg-white/70 p-4 shadow-2xl backdrop-blur">
                <div className="flex flex-wrap items-center gap-3">
                  <button
                    type="button"
                    onClick={() => setStep(currentStep - 1)}
                    disabled={currentStep <= 0}
                    className="rounded-md border border-white/50 bg-white/60 px-3 py-2 text-xs font-semibold text-slate-700 shadow-sm backdrop-blur disabled:opacity-50"
                  >
                    Prev
                  </button>
                  <button
                    type="button"
                    onClick={() => setStep(currentStep + 1)}
                    disabled={currentStep >= sortedPlaces.length - 1}
                    className="rounded-md border border-white/50 bg-white/60 px-3 py-2 text-xs font-semibold text-slate-700 shadow-sm backdrop-blur disabled:opacity-50"
                  >
                    Next
                  </button>
                  <div className="flex min-w-[220px] flex-1 items-center gap-3">
                    <input
                      type="range"
                      min={0}
                      max={Math.max(sortedPlaces.length - 1, 0)}
                      value={currentStep}
                      onChange={(e) => setStep(Number(e.target.value))}
                      className="w-full accent-[#991B1B]"
                    />
                  </div>
                </div>
                <div className="flex flex-wrap items-center justify-center gap-2 text-xs font-semibold text-slate-700">
                  <span className="text-slate-500">Timeline</span>
                  <span className="text-center">
                    {currentPlace ? `${currentPlace.periodLabel || ""} - ${currentPlace.title}` : "Chua co du lieu"}
                  </span>
                </div>
              </div>
            </div>
          ) : null}

        